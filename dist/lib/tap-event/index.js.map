{"version":3,"file":"index.js","sources":["../../../packages/tap-event/index.ts"],"sourcesContent":["export type TapHandler = (event: MouseEvent | TouchEvent) => void;\n\nexport interface HackEl extends HTMLElement {\n    _tapEventMap?: Map<TapHandler, { click?: TapHandler, touchStart?: TapHandler, touchEnd?: TapHandler }>\n}\nexport interface Modifiers {\n    stop?: boolean;\n    prevent?: boolean;\n    self?: boolean;\n    once?: boolean;\n}\n\nfunction checkTouchEvent<T extends TouchEvent | MouseEvent>(event: T): event is T & TouchEvent {\n    return 'touches' in event;\n}\n\nfunction createTouchEvent(modifiers: Modifiers, cb: TapHandler) {\n    let startX = 0;\n    let startY = 0;\n    let startTime = 0;\n    let oldTargetEl: EventTarget | null = null;\n\n    function touchStart(event: TouchEvent | MouseEvent) {\n        const e = checkTouchEvent(event) ? event.touches[0] : event;\n\n        startX = e.clientX;\n        startY = e.clientY;\n        startTime = Date.now();\n        oldTargetEl = event.currentTarget;\n\n        modifiers.stop && event.stopPropagation();\n        modifiers.prevent && event.preventDefault();\n    }\n\n    function touchEnd(event: TouchEvent | MouseEvent) {\n        const e = checkTouchEvent(event) ? event.changedTouches[0] : event;\n\n        const diffX = e.clientX - startX;\n        const diffY = e.clientY - startY;\n        const diffTime = Date.now() - startTime;\n        const targetEl = event.target;\n\n        modifiers.stop && event.stopPropagation();\n        modifiers.prevent && event.preventDefault();\n\n        if(\n            diffTime < 300 && Math.abs(diffX) < 10 && Math.abs(diffY) < 10 &&\n            ((modifiers.self && oldTargetEl === targetEl && event.currentTarget === targetEl) || !modifiers.self)\n        ) {\n            cb(event);\n\n            if(modifiers.once) {\n                unbindTap((targetEl as HTMLElement), cb);\n            }\n        }\n    }\n\n    return {\n        touchStart,\n        touchEnd\n    };\n}\n\nfunction createClickEvent(modifiers: Modifiers, cb: TapHandler) {\n    return function(event: TouchEvent | MouseEvent) {\n        const targetEl = event.target;\n\n        modifiers.stop && event.stopPropagation();\n        modifiers.prevent && event.preventDefault();\n\n        cb(event);\n\n        if(modifiers.once) {\n            unbindTap((targetEl as HTMLElement), cb);\n        }\n    };\n}\n\nexport function bindTap(el: HTMLElement, cb: TapHandler, modifiers?: Modifiers) {\n    const useTouch = 'ontouchend' in document;\n    const elHack = el as HackEl;\n\n    if (!elHack._tapEventMap) {\n        elHack._tapEventMap = new Map();\n    }\n\n    if (useTouch) {\n        const { touchStart, touchEnd } = createTouchEvent(modifiers || {}, cb);\n\n        el.addEventListener('touchstart', touchStart);\n        el.addEventListener('touchend', touchEnd);\n        elHack._tapEventMap.set(cb, { touchStart, touchEnd });\n    } else {\n        const click = createClickEvent(modifiers || {}, cb);\n\n        el.addEventListener('click', click);\n        elHack._tapEventMap.set(cb, { click });\n    }\n}\n\nexport function unbindTap(el: HTMLElement, cb?: TapHandler) {\n    const elHack = el as HackEl;\n\n    if (!elHack._tapEventMap) return;\n\n    function removeTapEvent(_cb: TapHandler) {\n        if (!elHack._tapEventMap) return;\n\n        const tapEvent = elHack._tapEventMap.get(_cb);\n\n        if (tapEvent) {\n            tapEvent.click && el.removeEventListener('click', tapEvent.click);\n            tapEvent.touchStart && el.removeEventListener('touchstart', tapEvent.touchStart);\n            tapEvent.touchEnd && el.removeEventListener('touchend', tapEvent.touchEnd);\n\n            elHack._tapEventMap.delete(_cb);\n        }\n    }\n\n    if (cb) {\n        removeTapEvent(cb);\n        return;\n    }\n    for(const _cb of elHack._tapEventMap.keys()) {\n        removeTapEvent(_cb);\n    }\n}"],"names":[],"mappings":";;;;AAYA,yBAA4D,OAAmC;AAC3F,SAAO,aAAa;AAAA;AAGxB,0BAA0B,WAAsB,IAAgB;AAC5D,MAAI,SAAS;AACb,MAAI,SAAS;AACb,MAAI,YAAY;AAChB,MAAI,cAAkC;AAEtC,sBAAoB,OAAgC;AAChD,UAAM,IAAI,gBAAgB,SAAS,MAAM,QAAQ,KAAK;AAEtD,aAAS,EAAE;AACX,aAAS,EAAE;AACX,gBAAY,KAAK;AACjB,kBAAc,MAAM;AAEpB,cAAU,QAAQ,MAAM;AACxB,cAAU,WAAW,MAAM;AAAA;AAG/B,oBAAkB,OAAgC;AAC9C,UAAM,IAAI,gBAAgB,SAAS,MAAM,eAAe,KAAK;AAE7D,UAAM,QAAQ,EAAE,UAAU;AAC1B,UAAM,QAAQ,EAAE,UAAU;AAC1B,UAAM,WAAW,KAAK,QAAQ;AAC9B,UAAM,WAAW,MAAM;AAEvB,cAAU,QAAQ,MAAM;AACxB,cAAU,WAAW,MAAM;AAE3B,QACI,WAAW,OAAO,KAAK,IAAI,SAAS,MAAM,KAAK,IAAI,SAAS,iBAChD,QAAQ,gBAAgB,YAAY,MAAM,kBAAkB,YAAa,CAAC,UAAU,OAClG;AACE,SAAG;AAEH,UAAG,UAAU,MAAM;AACf,kBAAW,UAA0B;AAAA;AAAA;AAAA;AAKjD,SAAO;AAAA,IACH;AAAA,IACA;AAAA;AAAA;AAIR,0BAA0B,WAAsB,IAAgB;AAC5D,SAAO,SAAS,OAAgC;AAC5C,UAAM,WAAW,MAAM;AAEvB,cAAU,QAAQ,MAAM;AACxB,cAAU,WAAW,MAAM;AAE3B,OAAG;AAEH,QAAG,UAAU,MAAM;AACf,gBAAW,UAA0B;AAAA;AAAA;AAAA;iBAKzB,IAAiB,IAAgB,WAAuB;AAC5E,QAAM,WAAW,gBAAgB;AACjC,QAAM,SAAS;AAEf,MAAI,CAAC,OAAO,cAAc;AACtB,WAAO,eAAe,IAAI;AAAA;AAG9B,MAAI,UAAU;AACV,UAAM,EAAE,YAAY,aAAa,iBAAiB,aAAa,IAAI;AAEnE,OAAG,iBAAiB,cAAc;AAClC,OAAG,iBAAiB,YAAY;AAChC,WAAO,aAAa,IAAI,IAAI,EAAE,YAAY;AAAA,SACvC;AACH,UAAM,QAAQ,iBAAiB,aAAa,IAAI;AAEhD,OAAG,iBAAiB,SAAS;AAC7B,WAAO,aAAa,IAAI,IAAI,EAAE;AAAA;AAAA;mBAIZ,IAAiB,IAAiB;AACxD,QAAM,SAAS;AAEf,MAAI,CAAC,OAAO;AAAc;AAE1B,0BAAwB,KAAiB;AACrC,QAAI,CAAC,OAAO;AAAc;AAE1B,UAAM,WAAW,OAAO,aAAa,IAAI;AAEzC,QAAI,UAAU;AACV,eAAS,SAAS,GAAG,oBAAoB,SAAS,SAAS;AAC3D,eAAS,cAAc,GAAG,oBAAoB,cAAc,SAAS;AACrE,eAAS,YAAY,GAAG,oBAAoB,YAAY,SAAS;AAEjE,aAAO,aAAa,OAAO;AAAA;AAAA;AAInC,MAAI,IAAI;AACJ,mBAAe;AACf;AAAA;AAEJ,aAAU,OAAO,OAAO,aAAa,QAAQ;AACzC,mBAAe;AAAA;AAAA;;;;;"}